#!/bin/bash

# ==========================================
# Database Setup — Install & Configure
# Handles installation + credential setup for all databases
# Run: db-setup [install|setup|mysql|pg|mongo|redis|compass|all]
# ==========================================

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

DB_PASS="1"
TARGET=${1:-help}

# Detect Ubuntu codename (Linux Mint uses its own codename, repos need Ubuntu's)
get_ubuntu_codename() {
    if grep -q UBUNTU_CODENAME /etc/os-release 2>/dev/null; then
        grep UBUNTU_CODENAME /etc/os-release | cut -d= -f2
    else
        lsb_release -cs
    fi
}
UBUNTU_CODENAME=$(get_ubuntu_codename)

show_help() {
    echo "Database Setup — Install & Configure"
    echo ""
    echo "Usage: db-setup <command>"
    echo ""
    echo "Commands:"
    echo "  install       Install all databases (MySQL, PostgreSQL, MongoDB, Redis + GUIs)"
    echo "  setup         Setup credentials for all databases"
    echo "  mysql         Install + setup MySQL"
    echo "  pg            Install + setup PostgreSQL + pgAdmin"
    echo "  mongo         Install + setup MongoDB + Compass"
    echo "  redis         Install + setup Redis"
    echo "  pgadmin       Install pgAdmin 4 (PostgreSQL GUI)"
    echo "  compass       Install MongoDB Compass (GUI)"
    echo "  all           Install + setup everything"
    echo ""
    echo "Default password for all databases: ${DB_PASS}"
}

# ==========================================
# Installation Functions
# ==========================================

install_mysql() {
    echo -e "${YELLOW}Installing MySQL...${NC}"
    if command -v mysql &>/dev/null; then
        echo -e "  ${GREEN}✓ MySQL already installed, skipping.${NC}"
        return 1
    fi
    sudo apt install -y mysql-server
    sudo systemctl stop mysql
    sudo systemctl disable mysql
    echo -e "  ${GREEN}✓ MySQL installed (stopped & disabled).${NC}"
    return 0
}

install_pg() {
    echo -e "${YELLOW}Installing PostgreSQL...${NC}"
    if command -v psql &>/dev/null; then
        echo -e "  ${GREEN}✓ PostgreSQL already installed, skipping.${NC}"
        return 1
    fi
    sudo sh -c "echo 'deb http://apt.postgresql.org/pub/repos/apt ${UBUNTU_CODENAME}-pgdg main' > /etc/apt/sources.list.d/pgdg.list"
    curl -fsSL https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo gpg --yes --dearmor -o /usr/share/keyrings/postgresql-archive-keyring.gpg 2>/dev/null || true
    wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add - 2>/dev/null || true
    sudo apt update
    sudo apt install -y postgresql postgresql-contrib
    sudo systemctl stop postgresql
    sudo systemctl disable postgresql
    echo -e "  ${GREEN}✓ PostgreSQL installed (stopped & disabled).${NC}"
    return 0
}

install_mongo() {
    echo -e "${YELLOW}Installing MongoDB (local)...${NC}"
    if command -v mongod &>/dev/null; then
        echo -e "  ${GREEN}✓ MongoDB already installed, skipping.${NC}"
        return 1
    fi
    curl -fsSL https://www.mongodb.org/static/pgp/server-8.0.asc | sudo gpg --yes --dearmor -o /usr/share/keyrings/mongodb-server-8.0.gpg 2>/dev/null
    echo "deb [signed-by=/usr/share/keyrings/mongodb-server-8.0.gpg] https://repo.mongodb.org/apt/ubuntu ${UBUNTU_CODENAME}/mongodb-org/8.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-8.0.list
    sudo apt update
    sudo apt install -y mongodb-org
    if command -v mongod &>/dev/null; then
        sudo systemctl stop mongod
        sudo systemctl disable mongod
        echo -e "  ${GREEN}✓ MongoDB installed (stopped & disabled).${NC}"
        return 0
    else
        echo -e "  ${RED}✗ MongoDB installation failed. Check repo/apt errors above.${NC}"
        return 1
    fi
}

install_redis() {
    echo -e "${YELLOW}Installing Redis...${NC}"
    if command -v redis-server &>/dev/null; then
        echo -e "  ${GREEN}✓ Redis already installed, skipping.${NC}"
        return 1
    fi
    sudo apt install -y redis-server
    sudo systemctl stop redis-server
    sudo systemctl disable redis-server

    # Configure basic persistence (AOF)
    sudo sed -i 's/^appendonly no/appendonly yes/' /etc/redis/redis.conf 2>/dev/null || true

    # Bind to localhost only (security)
    sudo sed -i 's/^bind .*/bind 127.0.0.1 ::1/' /etc/redis/redis.conf 2>/dev/null || true

    echo -e "  ${GREEN}✓ Redis installed (stopped & disabled, AOF persistence enabled).${NC}"
    return 0
}

install_compass() {
    echo -e "${YELLOW}Installing MongoDB Compass (GUI)...${NC}"
    if command -v mongodb-compass &>/dev/null; then
        echo -e "  ${GREEN}✓ MongoDB Compass already installed, skipping.${NC}"
        return 1
    fi
    cd /tmp
    echo -e "  ${CYAN}Downloading MongoDB Compass...${NC}"
    wget --progress=bar:force https://downloads.mongodb.com/compass/mongodb-compass_1.44.4_amd64.deb -O mongodb-compass.deb
    echo -e "  ${CYAN}Installing package...${NC}"
    sudo dpkg -i mongodb-compass.deb 2>/dev/null
    sudo apt install -f -y 2>/dev/null
    rm -f mongodb-compass.deb
    if command -v mongodb-compass &>/dev/null; then
        echo -e "  ${GREEN}✓ MongoDB Compass installed.${NC}"
        echo -e "  ${CYAN}Launch: mongodb-compass${NC}"
        return 0
    else
        echo -e "  ${RED}✗ MongoDB Compass installation failed.${NC}"
        return 1
    fi
}

install_pgadmin() {
    echo -e "${YELLOW}Installing pgAdmin 4 (PostgreSQL GUI)...${NC}"
    if command -v pgadmin4 &>/dev/null || dpkg -l pgadmin4-desktop 2>/dev/null | grep -q '^ii'; then
        echo -e "  ${GREEN}✓ pgAdmin 4 already installed, skipping.${NC}"
        return 1
    fi
    # Add pgAdmin APT repository
    curl -fsSL https://www.pgadmin.org/static/packages_pgadmin_org.pub | sudo gpg --yes --dearmor -o /usr/share/keyrings/pgadmin-keyring.gpg 2>/dev/null
    echo "deb [signed-by=/usr/share/keyrings/pgadmin-keyring.gpg] https://ftp.postgresql.org/pub/pgadmin/pgadmin4/apt/${UBUNTU_CODENAME} pgadmin4 main" | sudo tee /etc/apt/sources.list.d/pgadmin4.list
    sudo apt update
    echo -e "  ${CYAN}Installing pgAdmin 4 desktop...${NC}"
    sudo apt install -y pgadmin4-desktop
    if dpkg -l pgadmin4-desktop 2>/dev/null | grep -q '^ii'; then
        echo -e "  ${GREEN}✓ pgAdmin 4 installed.${NC}"
        echo -e "  ${CYAN}Launch: pgadmin4${NC}"
        return 0
    else
        echo -e "  ${RED}✗ pgAdmin 4 installation failed.${NC}"
        return 1
    fi
}

# ==========================================
# Credential Setup Functions
# ==========================================

setup_mysql() {
    echo -e "${YELLOW}Setting up MySQL credentials...${NC}"
    if ! command -v mysql &>/dev/null; then
        echo -e "  ${RED}✗ MySQL not installed, skipping.${NC}"
        return
    fi
    sudo systemctl start mysql
    sudo mysql -e "ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY '${DB_PASS}'; FLUSH PRIVILEGES;" 2>/dev/null || echo "  Password may already be set."
    sudo systemctl stop mysql
    echo -e "  ${GREEN}✓ MySQL root password set to '${DB_PASS}'${NC}"
    echo -e "  ${CYAN}Connect: mysql -u root -p${NC}"
}

setup_pg() {
    echo -e "${YELLOW}Setting up PostgreSQL credentials...${NC}"
    if ! command -v psql &>/dev/null; then
        echo -e "  ${RED}✗ PostgreSQL not installed, skipping.${NC}"
        return
    fi
    sudo systemctl start postgresql
    sudo -u postgres psql -c "ALTER USER postgres WITH PASSWORD '${DB_PASS}';" 2>/dev/null || echo "  Could not set postgres password."
    sudo systemctl stop postgresql
    echo -e "  ${GREEN}✓ PostgreSQL user 'postgres' password set to '${DB_PASS}'${NC}"
    echo -e "  ${CYAN}Connect: psql -U postgres -h localhost${NC}"
}

setup_mongo() {
    echo -e "${YELLOW}Setting up MongoDB credentials...${NC}"
    if ! command -v mongod &>/dev/null; then
        echo -e "  ${RED}✗ MongoDB not installed, skipping.${NC}"
        return
    fi
    sudo systemctl start mongod
    sleep 2
    mongosh --quiet --eval "
        use admin;
        db.createUser({
            user: 'admin',
            pwd: '${DB_PASS}',
            roles: [{ role: 'root', db: 'admin' }]
        });
    " 2>/dev/null || echo "  Admin user may already exist."
    sudo systemctl stop mongod
    # Enable authentication in mongod.conf
    if ! grep -q "^security:" /etc/mongod.conf; then
        echo -e "\nsecurity:\n  authorization: enabled" | sudo tee -a /etc/mongod.conf > /dev/null
    fi
    echo -e "  ${GREEN}✓ MongoDB admin user 'admin' / password '${DB_PASS}' created (auth enabled)${NC}"
    echo -e "  ${CYAN}Connect: mongosh -u admin -p --authenticationDatabase admin${NC}"
}

# ==========================================
# Combined: Install + Setup per service
# ==========================================

do_mysql() {
    install_mysql && setup_mysql
}

do_pg() {
    install_pg && setup_pg
    install_pgadmin
}

do_mongo() {
    install_mongo && setup_mongo
    install_compass
}

do_redis() {
    install_redis
}

# ==========================================
# Main
# ==========================================

case "$TARGET" in
    install)
        echo "=========================================="
        echo "  Database Installation"
        echo "=========================================="
        echo ""
        install_mysql && setup_mysql
        echo ""
        install_pg && setup_pg
        echo ""
        install_pgadmin
        echo ""
        install_mongo && setup_mongo
        echo ""
        install_compass
        echo ""
        install_redis
        echo ""
        echo -e "${GREEN}Database installation complete!${NC}"
        ;;
    setup)
        echo "=========================================="
        echo "  Database Credential Setup"
        echo "  Default password: ${DB_PASS}"
        echo "=========================================="
        echo ""
        setup_mysql
        echo ""
        setup_pg
        echo ""
        setup_mongo
        echo ""
        echo -e "${GREEN}==========================================${NC}"
        echo -e "${GREEN}  Credential setup complete!${NC}"
        echo -e "${GREEN}==========================================${NC}"
        echo ""
        echo "Credentials:"
        echo "  MySQL:      root / ${DB_PASS}"
        echo "  PostgreSQL: postgres / ${DB_PASS}"
        echo "  MongoDB:    admin / ${DB_PASS}"
        ;;
    mysql)   do_mysql ;;
    pg|postgresql) do_pg ;;
    mongo|mongodb) do_mongo ;;
    redis)   do_redis ;;
    pgadmin) install_pgadmin ;;
    compass) install_compass ;;
    all)
        echo "=========================================="
        echo "  Database Setup — Install & Configure All"
        echo "  Default password: ${DB_PASS}"
        echo "=========================================="
        echo ""
        do_mysql
        echo ""
        do_pg
        echo ""
        do_mongo
        echo ""
        do_redis
        echo ""
        echo -e "${GREEN}==========================================${NC}"
        echo -e "${GREEN}  All databases installed & configured!${NC}"
        echo -e "${GREEN}==========================================${NC}"
        echo ""
        echo "Credentials:"
        echo "  MySQL:      root / ${DB_PASS}"
        echo "  PostgreSQL: postgres / ${DB_PASS}"
        echo "  MongoDB:    admin / ${DB_PASS}"
        echo "  Redis:      no password"
        echo ""
        echo "GUI:"
        echo "  pgAdmin 4:       pgadmin4"
        echo "  MongoDB Compass: mongodb-compass"
        ;;
    -h|--help|help)
        show_help
        ;;
    *)
        echo "Unknown command: $TARGET"
        show_help
        exit 1
        ;;
esac
